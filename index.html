<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Kick-Only Optimized Test</title>
  <style>
    body { font-family: sans-serif; background: #111; color: #fff; display: flex; flex-direction: column; align-items: center; }
    .grid { display: grid; grid-template-columns: repeat(8, 40px); gap: 5px; margin: 10px 0; }
    .cell { width: 40px; height: 40px; border: 1px solid #555; border-radius: 6px; background: #222; cursor: pointer; transition: background 0.1s; }
    .cell.active { background: #0f0; }
    .cell.playhead { outline: 2px solid yellow; }
    .cell.glow { box-shadow: 0 0 10px 3px orange; }
    button { margin: 10px; padding: 8px 14px; background: #333; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    button.active { background: #ff6600; }
  </style>
</head>
<body>
  <h1>Kick-Only Sequencer (Optimized)</h1>
  <div class="grid" id="grid"></div>
  <button id="playBtn">Play</button>
  <button id="rollBtn">Toggle Roll FX</button>

  <script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let kickBuffer = null;
    const bpm = 120;
    const steps = 8;
    let stepIndex = 0;
    let playing = false;
    let nextNoteTime = 0;
    let lookahead = 25; // ms
    let scheduleAheadTime = 0.1; // sec
    let timerID;
    let rollActive = false;

    // Load Kick
    fetch("https://actions.google.com/sounds/v1/alarms/beep_short.ogg")
      .then(r => r.arrayBuffer())
      .then(b => audioCtx.decodeAudioData(b))
      .then(buf => kickBuffer = buf);

    // Build grid
    const gridEl = document.getElementById("grid");
    const cells = [];
    for (let i=0;i<steps;i++) {
      const cell = document.createElement("div");
      cell.classList.add("cell");
      cell.addEventListener("click",()=>cell.classList.toggle("active"));
      gridEl.appendChild(cell);
      cells.push(cell);
    }

    function playKick(time){
      const src = audioCtx.createBufferSource();
      src.buffer = kickBuffer;
      src.connect(audioCtx.destination);
      src.start(time);
    }

    function scheduleNote(beatNumber,time){
      if (cells[beatNumber].classList.contains("active")) {
        playKick(time);
        requestAnimationFrame(()=> {
          cells[beatNumber].classList.add("glow");
          setTimeout(()=>cells[beatNumber].classList.remove("glow"),100);
        });
      }
      requestAnimationFrame(()=> {
        cells.forEach((c,i)=>c.classList.toggle("playhead",i===beatNumber));
      });
    }

    function nextNote(){
      const stepDur = (60/bpm) / (rollActive ? 4 : 2); 
      nextNoteTime += stepDur;
      stepIndex = (stepIndex+1)%steps;
    }

    function scheduler(){
      while (nextNoteTime < audioCtx.currentTime + scheduleAheadTime) {
        scheduleNote(stepIndex,nextNoteTime);
        nextNote();
      }
      timerID = setTimeout(scheduler,lookahead);
    }

    document.getElementById("playBtn").addEventListener("click",()=>{
      if (!playing) {
        playing = true;
        stepIndex = 0;
        nextNoteTime = audioCtx.currentTime + 0.05;
        scheduler();
      } else {
        playing = false;
        clearTimeout(timerID);
      }
    });

    document.getElementById("rollBtn").addEventListener("click",()=>{
      rollActive = !rollActive;
      document.getElementById("rollBtn").classList.toggle("active", rollActive);
    });
  </script>
</body>
</html>
